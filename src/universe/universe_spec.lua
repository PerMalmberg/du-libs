---@diagnostic disable: need-check-nil
require("environment"):Prepare()
local CoreMock = require("mocks/CoreMock")
local Universe = require("universe/Universe")
local Position = require("universe/Position")
local Vec3 = require("math/Vec3")
local Ray = require("util/Ray")
local calc = require("util/Calc")

local u = Universe.Instance()
local positionOnAlioth = u.ParsePosition("::pos{0,2,7.7093,78.0806,34.7991}")
local positionAboveMarket6 = u.ParsePosition("::pos{0,2,35.9160,101.2832,132000.2500}")
local positionNearJago = u.ParsePosition("::pos{0,0,-102232240.0000,36433324.0000,11837611.0000}")
local positionNearTalemai = u.ParsePosition("::pos{0,0,-10126823.0000,53124664.0000,-14922930.0000}")
local positionNearThades = u.ParsePosition("::pos{0,0,37979880.0000,17169778.0000,-2641396.2500}")
local positionAboveIon = u.ParsePosition("::pos{0,0,2970018.8563,-98961141.3186,-787105.8790}")
local market6Pad = u.ParsePosition("::pos{0,2,36.0242,101.2872,231.3857}")
local sveaBaseSWSide = u.ParsePosition("::pos{0,2,7.5425,78.0995,47.6314}")

describe("Singelton", function()
    it("Are the same instance", function()
        assert.are_equal(Universe.Instance(), Universe.Instance())
    end)
end)

describe("Universe", function()
    it("Can create a Position", function()
        local p = Position.New(u.CurrentGalaxy(), u.ClosestBody(positionOnAlioth:Coordinates()), Vec3.New(1, 2, 3))
        local p2 = Position.New(u.CurrentGalaxy(), u.ClosestBody(positionOnAlioth:Coordinates()), Vec3.New(3, 4, 5))
        assert.are_equal(Vec3.New(1, 2, 3):Len(), p:Coordinates():Len())
        assert.are_equal("Alioth", p.Body.Name)
        assert.are_equal(Vec3.New(3, 4, 5):Len(), p2.Coords:Len())
    end)

    it("Can parse positions", function()
        assert.are_equal("::pos{0,2,7.7093,78.0806,34.7991}", tostring(positionOnAlioth))
        assert.are_equal("::pos{0,2,7.7093,78.0806,34.7991}", positionOnAlioth:AsPosString())
        assert.are_equal("::pos{0,2,35.9160,101.2832,132000.2500}", tostring(positionAboveMarket6))
        assert.are_equal("::pos{0,0,-102232240.0000,36433324.0000,11837611.0000}", tostring(positionNearJago))
        assert.are_equal("::pos{0,0,-10126823.0000,53124664.0000,-14922930.0000}", tostring(positionNearTalemai))
        assert.are_equal("::pos{0,0,37979880.0000,17169778.0000,-2641396.2500}", tostring(positionNearThades))
        assert.are_equal("::pos{0,0,2970018.8563,-98961141.3186,-787105.8790}", tostring(positionAboveIon))
        assert.are_equal("::pos{0,2,36.0242,101.2872,231.3857}", tostring(market6Pad))
        assert.are_equal("::pos{0,2,7.5425,78.0995,47.6314}", tostring(sveaBaseSWSide))

        assert.are_equal((positionOnAlioth.Coords - positionOnAlioth.Coords):Len(), 0)
        assert.are_equal(math.floor((sveaBaseSWSide.Coords - market6Pad.Coords):Len()), 76934)
    end)

    it("Handles invalid position strings", function()
        assert.is_nil(u.ParsePosition("foo"))
    end)

    it("Can reconstruct a position", function()
        local coordinate = positionOnAlioth.Coords
        local reconstructed = u.CreatePos(coordinate)
        assert.are_equal(tostring(reconstructed), tostring(positionOnAlioth))
    end)
end)

describe("Body", function()
    it("Can calculate distance to atmo", function()
        local aliCenter = Vec3.New( -8.00, -8.00, -126303.00)
        local b = u.ClosestBody(aliCenter)
        assert.are_equal("Alioth", tostring(b))
        local point10kmOutsideAtmo = aliCenter + Vec3.unit_x * (b.Atmosphere.Radius + 10000)
        assert.are_equal(10000, b:DistanceToAtmo(point10kmOutsideAtmo))
    end)

    it("Can detect if a point is in atmo", function()
        local aliCenter = Vec3.New( -8.00, -8.00, -126303.00)
        local b = u.ClosestBody(aliCenter)
        assert.are_equal("Alioth", tostring(b))
        local pointInsideAtmo = aliCenter + Vec3.unit_y * (b.Atmosphere.Radius / 2) ---@type Vec3
        assert.is_true(b:IsInAtmo(pointInsideAtmo))
    end)

    it("Can calculate the distance to atmo edge", function()
        local aliCenter = Vec3.New( -8.00, -8.00, -126303.00)
        local b = u.ClosestBody(aliCenter)
        assert.are_equal("Alioth", tostring(b))
        local pointInsideAtmo = aliCenter + Vec3.unit_y * (b.Atmosphere.Radius / 2) ---@type Vec3
        assert.equal(b.Atmosphere.Radius / 2, b:DistanceToAtmoEdge(pointInsideAtmo))

        local pointOutsideAtmo = aliCenter + Vec3.unit_y * (b.Atmosphere.Radius * 2) ---@type Vec3
        assert.equal(b.Atmosphere.Radius, b:DistanceToAtmoEdge(pointOutsideAtmo))
    end)
end)

describe("Detect bodies in flight path", function()
    local aliCenter = Vec3.New( -8.00, -8.00, -126303.00)
    local b = u.ClosestBody(aliCenter)

    local g = u.CurrentGalaxy()
    local point10kmOutsideAlioth = aliCenter + Vec3.unit_x * (b.Atmosphere.Radius + 10000)
    local ray = Ray.New(point10kmOutsideAlioth, (aliCenter - point10kmOutsideAlioth):Normalize())
    local bodies = g:BodiesInPath(ray)
    assert.are_equal(1, #bodies)
    assert.are_equal("Alioth", bodies[1].Name)

    local madisCenter = Vec3.New(17465536.00, 22665536.00, -34464.00)
    local ray = Ray.New(point10kmOutsideAlioth, (madisCenter - point10kmOutsideAlioth):Normalize())
    local bodies = g:BodiesInPath(ray)
    assert.are_equal(1, #bodies)
    assert.are_equal("Madis", bodies[1].Name)
end)

describe("Can calculate distance to sea level", function()
    it("Can see we're above and below sea level", function()
        local aliCenter = Vec3.New( -8.00, -8.00, -126303.00)
        local b = u.ClosestBody(aliCenter)
        local above = u.ParsePosition("::pos{0,2,49.9873,160.4911,34.6345}")
        local below = u.ParsePosition("::pos{0,2,49.5881,160.6972,-2.4599}")

        local aboveSea, dist = b.AboveSeaLevel(above.Coordinates())
        assert.is_true(aboveSea)
        assert.are_equal(34.6, calc.Round(dist, 1))

        aboveSea, dist = b.AboveSeaLevel(below.Coordinates())
        assert.is_false(aboveSea)
        assert.are_equal(2.5, calc.Round(dist, 1))
    end)
end)

describe("Vertical reference vector", function()
    it("Can get the vertical reference vector", function()
        local vRef = u.VerticalReferenceVector()
        assert.is_not_nil(vRef.x)
        assert.is_not_nil(vRef.y)
        assert.is_not_nil(vRef.z)

        CoreMock.Instance().SetWorldGravity(Vec3.New(0, 0, 0))
        vRef = u.VerticalReferenceVector()
        assert.is_not_nil(vRef.x)
        assert.is_not_nil(vRef.y)
        assert.is_not_nil(vRef.z)
        assert.are_equal(0, vRef.x)
        assert.are_equal(0, vRef.y)
        assert.are_equal(0, vRef.z)
    end)
end)
